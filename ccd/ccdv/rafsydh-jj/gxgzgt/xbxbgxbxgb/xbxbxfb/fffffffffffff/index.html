<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø§Ø³Ø­ ÙˆÙ…ÙˆÙ„Ù‘Ø¯ QR â€” Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø©</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa3b2; --accent:#06b6d4;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:
        radial-gradient(800px 400px at 10% 10%, rgba(6,182,212,0.06), transparent),
        linear-gradient(180deg,#071029 0%, #071a2a 100%);
      color:#e6eef6; min-height:100vh; padding:18px;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:980px;margin:0 auto;display:grid;grid-template-columns:1fr;gap:16px}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    h1{font-size:18px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 24px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"], textarea, select{
      width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);
      background:rgba(255,255,255,0.02);color:inherit;font-size:14px;
    }
    button{
      background:linear-gradient(90deg,var(--accent),#7c3aed);border:0;padding:10px 12px;border-radius:10px;color:#021018;
      cursor:pointer;font-weight:600;
    }
    .muted{color:var(--muted);font-size:13px}
    #video{width:100%;height:320px;border-radius:10px;background:#000;object-fit:cover}
    .preview{display:flex;gap:12px;align-items:center}
    .qr-box{width:200px;height:200px;background:var(--glass);display:flex;align-items:center;justify-content:center;border-radius:10px}
    .result{word-break:break-all;background:rgba(0,0,0,0.25);padding:10px;border-radius:8px}
    .flex{display:flex;gap:8px;align-items:center}
    footer{color:var(--muted);font-size:13px;text-align:center;padding:8px}
    @media (max-width:860px){
      .grid{grid-template-columns:1fr}
      .qr-box{width:160px;height:160px}
    }
  </style>
  <!-- Ù…ÙƒØªØ¨Ø§Øª: Ù…Ø³Ø­ QR Ùˆ ØªÙˆÙ„ÙŠØ¯ QR -->
  <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.min.js"></script>
  <!-- qrcodejs Ù„Ø§ ÙŠØ²Ø§Ù„ ÙƒØ§ÙÙŠØ§Ù‹ Ù„Ù…ÙˆÙ„Ø¯ Ø§Ø­ØªØ±Ø§ÙÙŠ Ø¨Ø³ÙŠØ·Ø› Ù†Ø³ØªØ®Ø¯Ù…Ù‡ Ù„Ø¥Ù†Ø´Ø§Ø¡ PNG Ø¨Ø³Ù‡ÙˆÙ„Ø© -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <div>
        <h1>Ù…Ø§Ø³Ø­ ÙˆÙ…ÙˆÙ„Ù‘Ø¯ QR</h1>
        <p class="lead">Ù…Ø³Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ØŒ Ø±ÙØ¹ ØµÙˆØ±Ø©ØŒ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² QR â€” Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø© ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØµÙØ­</p>
      </div>
      <div class="muted">Ù…ØµÙ…Ù… RAYAN ğŸŒŸ</div>
    </header>

    <!-- Ù…Ø³Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <strong>Ù…Ø³Ø­ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</strong>
        <div class="flex">
          <label for="cameraSelect" class="muted">Ø§Ø®ØªØ± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</label>
          <select id="cameraSelect"></select>
        </div>
      </div>

      <div class="grid">
        <div>
          <video id="video" muted playsinline></video>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="startBtn">ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
            <button id="stopBtn" disabled>Ø¥ÙŠÙ‚Ø§Ù</button>
            <button id="snapBtn">Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø©</button>
            <input id="fileInput" type="file" accept="image/*" style="display:none"/>
            <button id="uploadBtn">ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø©</button>
          </div>
        </div>

        <div>
          <label class="muted">Ø§Ù„Ù†ØªÙŠØ¬Ø© / Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙÙƒÙˆÙƒ</label>
          <div class="result" id="scanResult">â€” Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù…Ø³Ø­ Ø¨Ø¹Ø¯ â€”</div>
          <div style="margin-top:8px;" class="controls">
            <button id="copyScan">Ù†Ø³Ø®</button>
            <button id="openScan">ÙØªØ­ (ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©)</button>
            <button id="clearHistory">Ù…Ø³Ø­ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
          </div>

          <hr style="margin:12px 0;border-color:rgba(255,255,255,0.03)"/>

          <label class="muted">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³Ø­ (Ø£Ø­Ø¯Ø« 10)</label>
          <div id="history" class="muted" style="max-height:160px;overflow:auto;padding:6px;border-radius:8px;background:rgba(255,255,255,0.02)"></div>
        </div>
      </div>
    </section>

    <!-- Ù…ÙˆÙ„Ø¯ QR -->
    <section class="card">
      <strong>Ù…ÙˆÙ„Ù‘Ø¯ QR</strong>
      <div style="margin-top:10px" class="grid">
        <div>
          <label>Ø§Ù„Ù†Øµ Ø£Ùˆ Ø§Ù„Ø±Ø§Ø¨Ø·</label>
          <textarea id="qrText" rows="4" placeholder="Ø¶Ø¹ Ù†Øµ Ø£Ùˆ Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§"></textarea>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="genBtn">Ø¥Ù†Ø´Ø§Ø¡</button>
            <button id="downloadQr" disabled>ØªØ­Ù…ÙŠÙ„ PNG</button>
            <button id="copyQr" disabled>Ù†Ø³Ø® Ø§Ù„Ù†Øµ</button>
          </div>
        </div>
        <div>
          <label class="muted">Ù…Ø¹Ø§ÙŠÙ†Ø©</label>
          <div class="qr-box" id="qrcode"></div>
          <div style="margin-top:8px" class="muted">Ù…Ù‚Ø§Ø³: <span id="qrSize">200</span>Ã—200</div>
        </div>
      </div>
    </section>

    <footer>Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± HTTPS Ø£Ùˆ Ø¹Ù„Ù‰ <code>localhost</code>.</footer>
  </div>

<script>
/* ============================
   Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
   ============================ */
const video = document.getElementById('video');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const snapBtn = document.getElementById('snapBtn');
const uploadBtn = document.getElementById('uploadBtn');
const fileInput = document.getElementById('fileInput');
const cameraSelect = document.getElementById('cameraSelect');
const scanResult = document.getElementById('scanResult');
const historyEl = document.getElementById('history');
const copyScan = document.getElementById('copyScan');
const openScan = document.getElementById('openScan');
const clearHistory = document.getElementById('clearHistory');

const qrText = document.getElementById('qrText');
const genBtn = document.getElementById('genBtn');
const qrcodeWrapper = document.getElementById('qrcode');
const downloadQr = document.getElementById('downloadQr');
const copyQr = document.getElementById('copyQr');
const qrSize = document.getElementById('qrSize');

/* ============================
   Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©
   ============================ */
let qrScanner = null;
let isScanning = false;
let scanHistory = [];
let qrInstance = null; // Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… QRCode.js

/* ============================
   Ø¯ÙˆØ§Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ / Ø§Ù„Ù…Ø³Ø­
   ============================ */
async function enumerateCameras(){
  cameraSelect.innerHTML = '';
  try{
    // Ù†Ø³ØªØ®Ø¯Ù… QrScanner.listCameras Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªØ§Ø­Ø© (ØªÙ…Ù†Ø­ ØªØ³Ù…ÙŠØ§Øª Ø£ÙØ¶Ù„)
    let cams = [];
    if (typeof QrScanner !== 'undefined' && typeof QrScanner.listCameras === 'function') {
      try {
        cams = await QrScanner.listCameras(true);
      } catch(e){ cams = []; }
    }

    if(!Array.isArray(cams) || cams.length === 0){
      // fallback Ø¥Ù„Ù‰ enumerateDevices
      if(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices){
        const devices = await navigator.mediaDevices.enumerateDevices();
        cams = devices.filter(d => d.kind === 'videoinput').map((d, i) => ({ id: d.deviceId, label: d.label || `Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ${i+1}` }));
      }
    }

    if(!cams || cams.length === 0){
      const opt = document.createElement('option'); opt.textContent='Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ§Ù…ÙŠØ±Ø§'; cameraSelect.appendChild(opt);
      return;
    }

    cams.forEach((c, i) => {
      const opt = document.createElement('option');
      opt.value = c.id || c.deviceId || c;
      opt.textContent = c.label || c.name || `Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ${i+1}`;
      cameraSelect.appendChild(opt);
    });
    cameraSelect.selectedIndex = 0;
  }catch(err){
    console.warn('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª', err);
    const opt = document.createElement('option'); opt.textContent='Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª'; cameraSelect.appendChild(opt);
  }
}

async function startScanner(){
  if(isScanning) return;
  // ØªØ¯Ù…ÙŠØ± Ø£ÙŠ Ù…ÙØ³Ø­Ù‘Ù‚ Ø³Ø§Ø¨Ù‚
  try{ if(qrScanner){ await qrScanner.stop(); qrScanner.destroy(); qrScanner = null; } }catch(e){}

  const deviceId = cameraSelect.value || null;
  try{
    const options = { highlightScanRegion: true, maxScansPerSecond: 3 };
    if(deviceId) options.preferredCamera = deviceId;
    qrScanner = new QrScanner(video, result => onScan(result), options);
    await qrScanner.start();
    isScanning = true;
    startBtn.disabled = true;
    stopBtn.disabled = false;
  }catch(err){
    console.error('Ø®Ø·Ø£ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­:', err);
    alert('ØªØ¹Ø°Ù‘Ø± Ø¨Ø¯Ø¡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + (err && err.message ? err.message : err));
    isScanning = false;
    startBtn.disabled = false;
    stopBtn.disabled = true;
  }
}

async function stopScanner(){
  if(!isScanning && !qrScanner){ startBtn.disabled = false; stopBtn.disabled = true; return; }
  try{
    if(qrScanner){ await qrScanner.stop(); qrScanner.destroy(); qrScanner = null; }
  }catch(e){ console.warn('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù', e); }
  isScanning = false;
  startBtn.disabled = false;
  stopBtn.disabled = true;
}

function onScan(result){
  if(!result) return;
  const text = (typeof result === 'string') ? result : (result.data || JSON.stringify(result));
  scanResult.textContent = text;
  addHistory(text);
}

/* ============================
   Ø³Ø¬Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
   ============================ */
function addHistory(text){
  if(!text) return;
  scanHistory.unshift({ text, when: new Date().toLocaleString() });
  if(scanHistory.length > 10) scanHistory.pop();
  renderHistory();
}
function renderHistory(){
  historyEl.innerHTML = '';
  if(scanHistory.length === 0){ historyEl.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø¨Ø¹Ø¯'; return; }
  scanHistory.forEach(item=>{
    const d = document.createElement('div');
    d.style.padding='6px'; d.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    d.innerHTML = `<div style="font-size:13px">${escapeHtml(item.text)}</div><div class="muted" style="font-size:12px;margin-top:6px">${item.when}</div>`;
    d.addEventListener('click', ()=>{ scanResult.textContent = item.text; });
    historyEl.appendChild(d);
  });
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* ============================
   Ø±ÙØ¹ ØµÙˆØ±Ø© ÙˆÙÙƒÙ‡Ø§
   ============================ */
uploadBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const img = new Image();
  img.onload = async ()=>{
    try{
      const result = await QrScanner.scanImage(img, { returnDetailedScanResult: false });
      onScan(result);
    }catch(err){
      alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù…Ø² QR ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©.');
      console.log(err);
    } finally {
      try{ URL.revokeObjectURL(img.src); }catch(e){}
    }
  };
  img.onerror = ()=> alert('ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©');
  img.src = URL.createObjectURL(f);
});

/* ============================
   Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆÙÙƒÙ‡Ø§
   ============================ */
snapBtn.addEventListener('click', async ()=>{
  if(!video || video.readyState < 2) return alert('Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø¹Ø¯.');
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth || 800;
  canvas.height = video.videoHeight || 600;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const img = new Image();
  img.src = canvas.toDataURL('image/png');
  img.onload = async ()=>{
    try{
      const result = await QrScanner.scanImage(img, { returnDetailedScanResult: false });
      onScan(result);
    }catch(err){
      alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ QR ÙÙŠ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·.');
    }
  };
});

/* ============================
   Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø³Ø® / Ø§Ù„ÙØªØ­ / Ù…Ø³Ø­
   ============================ */
copyScan.addEventListener('click', async ()=>{
  const text = scanResult.textContent;
  if(!text || text.includes('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù…Ø³Ø­')) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªÙŠØ¬Ø© Ù„Ù†Ø³Ø®Ù‡Ø§');
  try{ await navigator.clipboard.writeText(text); alert('ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©'); }
  catch(e){ alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø³Ø® â€” Ø§Ù„Ù…ØªØµÙØ­ Ù‚Ø¯ ÙŠÙ…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø§ÙØ¸Ø©.'); }
});
openScan.addEventListener('click', ()=>{
  const text = scanResult.textContent;
  if(!text || text.includes('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù…Ø³Ø­')) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªÙŠØ¬Ø© Ù„ÙØªØ­Ù‡Ø§');
  try{ const url = new URL(text); window.open(url.href, '_blank'); }
  catch(e){ window.open('https://www.google.com/search?q=' + encodeURIComponent(text), '_blank'); }
});
clearHistory.addEventListener('click', ()=>{ scanResult.textContent = 'â€” Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù…Ø³Ø­ Ø¨Ø¹Ø¯ â€”'; });

/* ============================
   Ù…ÙˆÙ„Ø¯ QR Ø§Ø­ØªØ±Ø§ÙÙŠ (Ù…Ø³ØªÙ‚Ø±)
   - ÙŠØ³ØªØ®Ø¯Ù… qrcodejs Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± (img Ø£Ùˆ canvas)
   - ÙŠÙˆÙÙ‘Ø± ØªÙ†Ø²ÙŠÙ„ PNG Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ© Ø¹Ø¨Ø± canvas
   ============================ */
function clearQrPreview(){
  qrcodeWrapper.innerHTML = '';
}
function generateQr(){
  const text = qrText.value.trim();
  clearQrPreview();
  downloadQr.disabled = true;
  copyQr.disabled = true;
  if(!text){ alert('Ø¶Ø¹ Ù†ØµØ§Ù‹ Ø£Ùˆ Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§ Ø£ÙˆÙ„Ø§Ù‹'); return; }

  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ø­ØªØ±Ø§ÙÙŠØ©: Ø­Ø¬Ù… Ø£ÙƒØ¨Ø± Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹ Ø«Ù… ØªØµØºÙŠØ± Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬ÙˆØ¯Ø© ØªÙ†Ø²ÙŠÙ„ Ø£ÙØ¶Ù„
  const size = 1000; // Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù†ÙØ³ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ø±ÙØ¹ Ø¯Ù‚Ø© Ø§Ù„ØªÙ†Ø²ÙŠÙ„
  const displaySize = 800; // Ù…Ø§ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
  qrSize.textContent = displaySize;

  // Ù†Ø³ØªØ®Ø¯Ù… Ø¹Ù†ØµØ± Ù…Ø¤Ù‚Øª Ù„Ø¥Ù†Ø´Ø§Ø¡ QR Ø¨Ø¯Ù‚Ø© Ø£Ø¹Ù„Ù‰ØŒ Ø«Ù… Ù†Ø¹Ø±Ø¶ Ù†Ø³Ø®Ø© Ù…ØµØºÙ‘Ø±Ø©
  const tmp = document.createElement('div');
  // ØªÙˆÙ„ÙŠØ¯ QR Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©
  const q = new QRCode(tmp, {
    text,
    width: size,
    height: size,
    correctLevel: QRCode.CorrectLevel.H
  });


  // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ QR
   const sound = document.getElementById("qrSound");
   sound.currentTime = 0; 
   sound.play();


  // Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„ (Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª ØªØ¶Ø¹ canvas Ø£Ùˆ img) Ù†Ø­ÙˆÙ‘Ù„ Ø¥Ù„Ù‰ canvas Ø¨Ø¯Ù‚Ø© displaySize
  setTimeout(()=> {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ canvas Ø£Ùˆ img Ø¯Ø§Ø®Ù„ tmp
    const canvas = tmp.querySelector('canvas');
    const img = tmp.querySelector('img');

    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª canvas Ù…ØªØ§Ø­Ø© Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ ÙƒÙ…Ø±Ø¬Ø¹
    let sourceCanvas = null;
    if(canvas){
      sourceCanvas = canvas;
    } else if(img){
      // Ø¥Ù† ÙˆÙØ¬Ø¯ imgØŒ Ù†Ø±Ø³Ù…Ù‡ Ø¹Ù„Ù‰ canvas
      const c = document.createElement('canvas');
      c.width = size; c.height = size;
      const ctx = c.getContext('2d');
      ctx.drawImage(img, 0, 0, size, size);
      sourceCanvas = c;
    }

    if(!sourceCanvas){
      // ÙØ´Ù„ Ø§Ù„ØªÙˆÙ„ÙŠØ¯
      clearQrPreview();
      alert('ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² QR. Ø­Ø§ÙˆÙ„ Ù…Ø±Ù‘Ø© Ø£Ø®Ø±Ù‰.');
      return;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ù†ÙØ³ Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ù…Ù‚Ø§Ø³ displaySize ÙˆÙ†Ù‚Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„ÙŠÙ‡ (Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ¯Ø©)
    const previewCanvas = document.createElement('canvas');
    previewCanvas.width = displaySize;
    previewCanvas.height = displaySize;
    const pctx = previewCanvas.getContext('2d');
    // Ù†Ø±Ø³Ù… Ø§Ù„Ù…ØµØ¯Ø± Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„ØªØµÙÙŠØ© ÙˆØ§Ù„ØªÙ‚Ù„ÙŠÙ„)
    pctx.drawImage(sourceCanvas, 0, 0, displaySize, displaySize);

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©: Ù†Ø³ØªØ®Ø¯Ù… img Ù„ÙŠÙƒÙˆÙ† Ø³Ù‡Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ø¨Ø± a.href
    const dataUrlPreview = previewCanvas.toDataURL('image/png');
    const imgEl = document.createElement('img');
    imgEl.src = dataUrlPreview;
    imgEl.width = displaySize;
    imgEl.height = displaySize;
    imgEl.alt = 'QR code preview';

    // Ù†Ø¯Ø±Ø¬ Ø§Ù„ØµÙˆØ±Ø© ÙƒÙ…Ø­ØªÙˆÙ‰ Ø¯Ø§Ø®Ù„ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    clearQrPreview();
    qrcodeWrapper.appendChild(imgEl);

    // Ù†Ø¹Ø¯ Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„ÙƒÙŠ ÙŠØ³ØªØ®Ø¯Ù… ØµÙˆØ±Ø© Ø¨Ø¯Ù‚Ø© Ø£Ø¹Ù„Ù‰ (Ù…Ù† sourceCanvas)
    downloadQr.disabled = false;
    copyQr.disabled = false;

    // Ø­ÙØ¸ Ù…Ø±Ø¬Ø¹ Ù„ÙƒØ§Ù†ÙØ³ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¯Ù‚Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ DOM (Ù…Ø®ÙÙŠ) Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ø¹Ù†Ø¯ Ø§Ù„ØªÙ†Ø²ÙŠÙ„
    sourceCanvas.style.display = 'none';
    sourceCanvas.id = 'qrHighResCanvas';
    // Ø¥Ù† ÙƒØ§Ù† Ù…ØµØ¯Ø±Ù‹Ø§ img Ù‚Ù…Ù†Ø§ Ø¨ØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ canvas Ù‚Ø¨Ù„Ø› Ø£Ù…Ø§ Ø¥Ù† ÙƒØ§Ù† canvas ÙÙ‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© ØªØ¶ÙŠÙÙ‡ Ù…Ø®ÙÙŠ
    if(!document.getElementById('qrHighResCanvas')){
      document.body.appendChild(sourceCanvas);
    } else {
      // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø³Ø§Ø¨Ù‚Ù‹Ø§
      const old = document.getElementById('qrHighResCanvas');
      old.replaceWith(sourceCanvas);
      sourceCanvas.id = 'qrHighResCanvas';
      sourceCanvas.style.display = 'none';
    }

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¤Ù‚Øª
    tmp.remove();
  }, 120);
}

genBtn.addEventListener('click', generateQr);

downloadQr.addEventListener('click', ()=>{
  // Ù†Ø£Ø®Ø° Ø§Ù„ÙƒØ§Ù†ÙØ³ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¯Ù‚Ø© ÙˆÙ†Ø­ÙˆÙ„Ù‡ Ø¥Ù„Ù‰ Ù…Ù„Ù PNG
  const high = document.getElementById('qrHighResCanvas');
  if(high && high.toDataURL){
    const dataUrl = high.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = 'qrcode.png';
    document.body.appendChild(a);
    a.click();
    a.remove();
  }else{
    // ÙƒØ­Ù„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ: Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ÙƒØ§Ù†ÙØ³ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¯Ù‚Ø© Ù†Ø³ØªØ®Ø¯Ù… ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    const img = qrcodeWrapper.querySelector('img');
    if(!img || !img.src){ return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„ØªØ­Ù…ÙŠÙ„Ù‡Ø§'); }
    const a = document.createElement('a');
    a.href = img.src;
    a.download = 'qrcode.png';
    document.body.appendChild(a);
    a.click();
    a.remove();
  }
});

copyQr.addEventListener('click', async ()=>{
  const text = qrText.value.trim();
  if(!text) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ Ù„Ù†Ø³Ø®Ù‡');
  try{ await navigator.clipboard.writeText(text); alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ'); }
  catch(e){ alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø³Ø® â€” Ø§Ù„Ù…ØªØµÙØ­ Ù‚Ø¯ ÙŠÙ…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø§ÙØ¸Ø©.'); }
});

/* ============================
   Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
   ============================ */
(async function init(){
  await enumerateCameras();

  if(navigator.mediaDevices && typeof navigator.mediaDevices.addEventListener === 'function'){
    navigator.mediaDevices.addEventListener('devicechange', async ()=> {
      await enumerateCameras();
    });
  }

  cameraSelect.addEventListener('change', async ()=>{
    if(isScanning){
      await stopScanner();
      setTimeout(()=> startScanner(), 300);
    }
  });

  startBtn.addEventListener('click', startScanner);
  stopBtn.addEventListener('click', stopScanner);

  if(!('mediaDevices' in navigator)) {
    startBtn.disabled = true;
    alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.');
  }

  qrSize.textContent = 200;
})();

/* ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø© */
window.addEventListener('beforeunload', async ()=> {
  if(qrScanner){
    try{ await qrScanner.destroy(); }catch(e){}
    qrScanner = null;
  }
});
</script>
<audio id="qrSound">
  <source src="success.mp3" type="audio/mpeg">
</audio>

</body>
</html>

